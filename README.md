# Перезаливатор
Приложение для "перезаливки" баз данных 1С:Предприятия. 

Реализовано на OneScript (http://oscript.io). Для работы необходим OneScript версии 1.0.20 или выше.

## Описание
Под словом "перезалить" понимается процедура восстановления одной базы данных из резервных копий другой базы данных.
Например, если необходимо загрузить данные из базы продуктива в тестовую или разработочную.

Перезаливатор позволяет максимально автоматизировать процесс "перезаливки" баз данных 1С:Предприятия. 

Имеется GUI-интерфейс для выбора базы-приемника и базы-назначения, а также окно с выводом результата.

<img src="https://github.com/Tavalik/Perezalivator/raw/master/Screenshots/Perezalivator1.png" alt="Скриншот1">

## Установка

1. Скачать файл "Distr\Perezalivator-<версия>.ospx"
2. Запустить установку с помощью пакетного менеджера opm

Установка:
``` cmd
opm install -f <Путь к файлу Perezalivator-<версия>.ospx>
```

Можно также воспользоваться командным файлом "install.bat" из директории "Distr"

### Зависимости 

Зависит от:
* Библиотеки **json**: https://github.com/oscript-library/json
* Библиотеки **gui**: https://github.com/oscript-library/oscript-simple-gui
* Библиотеки **TRun1C**: https://github.com/Tavalik/TRun1C
* Библиотеки **TMail**: https://github.com/Tavalik/TMail
* Библиотеки **TLog**: https://github.com/Tavalik/TLog

(все зависимые библиотеки устанавливаются автоматически при условии использования пакетного менеджера opm)

## Описание и работа с приложением

Запуск приложения осуществляется запуском файла **Perezalivator_Run.bat**.
При первом запуске в текущем каталоге будет создан пустой файл настроек **Perezalivator_Params.json**. 

Необходимо заполнить все параметры, описав возможные базы-источники, базы-назначения и параметры для отправки электронных писем.

Проверить корректность введенных настроек можно запустив файл **Perezalivator_Run_Test.bat**. Перезаливатор будет запущен в режиме тестирования настроек.

При следующем запуске файла **Perezalivator_Run.bat** откроется окно, в котором необходимо выбрать базу-источник

<img src="https://github.com/Tavalik/Perezalivator/raw/master/Screenshots/Perezalivator2.png" alt="Скриншот2">

и базу-назначения.

<img src="https://github.com/Tavalik/Perezalivator/raw/master/Screenshots/Perezalivator3.png" alt="Скриншот3">

Если необходимо, можно указать дату, на которую необходимо получить данные (всегда используется конец дня).

После указания всех исходных параметров, перезаливатор начнет работу по следующему алгоритму:

1. Установка блокировки регламентных заданий и начала сеансов в базе-приемнике
2. Завершение активных сеансов (спустя несколько минут) в базе-приемнике
3. Расчет последовательности файлов резервных копий для **базы-источника** для восстановления на указанную дату
4. Восстановление базы-приемника по найденной последовательности файлов
5. Перевод базы-приемника в простую модель восстановления
6. Сжатие файлов журнала транзакций базы-приемника
7. Отключение базы-приемника от хранилища
8. Подключение базы-приемника к хранилищу
9. Обновление конфигурации базы данных базы-приемника
10. Снятие блокировки регламентных заданий и начала сеансов базы-приемника
11. Уведомление о результате по электронной почте

Если в базе-приемнике присутствуют активные соединения, будет показана таблица со всеми соединениями, а также будет предоставлена возможность завершить все активные сеансы.

<img src="https://github.com/Tavalik/Perezalivator/raw/master/Screenshots/Perezalivator4.png" alt="Скриншот4">

Отработав, Перезаливатор выдаст соответствующее сообщение (или сообщение об ошибке), а также отправит сообщение о результате работы на электронную почту.

<img src="https://github.com/Tavalik/Perezalivator/raw/master/Screenshots/Perezalivator5.png" alt="Скриншот5">
