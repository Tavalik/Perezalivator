# Перезаливатор
Приложение для "перезаливки" баз данных 1С:Предприятия. 

Реализовано на OneScript (http://oscript.io). Для работы необходим OneScript версии 1.0.20 или выше.

## Описание
Под словом "перезалить" понимается процедура восстановления одной базы данных из резервных копий другой базы данных.
Например, если необходимо загрузить данные из базы продуктива в тестовую или разработочную.

Перезаливатор позволяет максимально автоматизировать процесс "перезаливки" баз данных 1С:Предприятия. 
Имеется возможность создания и удаления информационных баз.
Имеется GUI-интерфейс для выбора базы-приемника и базы-назначения, а также окно с выводом результата.

## Установка

1. Скачать файл "Distr\Perezalivator-<версия>.ospx"
2. Запустить установку с помощью пакетного менеджера opm

Установка:
``` cmd
opm install -f <Путь к файлу Perezalivator-<версия>.ospx>
```

Можно также воспользоваться командным файлом "install.bat" из директории "Distr"

### Зависимости 

Зависит от:
* Библиотеки **json**: https://github.com/oscript-library/json
* Библиотеки **gui**: https://github.com/oscript-library/oscript-simple-gui
* Библиотеки **TMSSQL**: https://github.com/Tavalik/TMSSQL
* Библиотеки **TRun1C**: https://github.com/Tavalik/TRun1C
* Библиотеки **TMail**: https://github.com/Tavalik/TMail
* Библиотеки **TLog**: https://github.com/Tavalik/TLog

(все зависимые библиотеки устанавливаются автоматически при условии использования пакетного менеджера opm)

## Описание и работа с приложением

# Инициализация

Инициализация осуществляется запуском файла **Perezalivator_Run.bat**.

При первом запуске в текущем каталоге будет создан пустой файл настроек **Perezalivator_Params.json**. 
Необходимо заполнить все параметры, описав возможные базы-источники, базы-назначения и параметры для отправки электронных писем.

# Тестирование настроек
Проверить корректность введенных настроек можно запустив файл **Perezalivator_Run_Test.bat**. Перезаливатор будет запущен в режиме тестирования настроек.

# Перезаливака и Создание ИБ

При последующих запусках файла **Perezalivator_Run.bat** откроется диалоговое окно, в котором необходимо уточнить параметры

<img src="Screenshots/Perezalivator20.png" alt="Скриншот20">

1. Информационная база источник
2. Информационная база назначения (приемник)
3. Галочка *Создать ИБ Приемник* раскрывает возможность уточнения имени информационной базы
    > *ИмяБазы* подтягивается из соответствующего параметра,
    > при этом *ИмяБазыДанныхSQL* примет значение введенному в *ИмяБазы*
Указываем один из 3-х альтернативных вариантов получения среза данных:
4. Дата, на которую необходимо получить данные (по умолчанию - текущая, конец дня)
5. Галочка *на момент времени* раскрывает возможность уточнения *момента Времени* (а если требуется - и даты)
    > поле символьное, поэтому важно выдержать формат "dd.MM.yyyy ЧЧ:мм:сс"
    > Если для БД Источник не установлена ПОЛНАЯ (FULL) модель восстановления,-
    > то восстановление данных будет произведено на время ближайшего разностного (или полного) бэкапа
    > (о чем будет соответствующее сообщение в логах - см. ниже)
6. Галочка *текущая копия базы* - получение копии текущего состояния данных
    > Предварительно будет создана полная (FULL) копия базы данных в режиме только для копирования (COPY_ONLY)
    > Копия будет создана в каталоге бэкапов по умолчанию, но это не влияет на последовательность создания традиционных резервных копий.
    > По окончании восстановления, созданный бэкап будет удален.
7. Жмем выполнить и далее подтверждаем намерение о перезаливке.

8. Если в базе-приемнике присутствуют активные соединения, будет показана таблица со всеми соединениями, а также будет предоставлена возможность завершить все активные сеансы.

<img src="Screenshots/Perezalivator21.png" alt="Скриншот21">

После указания всех исходных параметров, перезаливатор начнет работу по следующему алгоритму:

1. Создание ИБ Приемник (по необходимости)
2. Установка блокировки регламентных заданий и начала сеансов в базе-приемнике
3. Завершение активных сеансов (спустя несколько минут) в базе-приемнике
4. Создание текущей резервной копии в режиме *только для копирования* (по необходимости)
5. Расчет последовательности файлов резервных копий для **базы-источника** для восстановления на указанную дату
6. Восстановление базы-приемника по найденной последовательности файлов (удаление временного бэкапа по необходимости)
7. Перевод базы-приемника в простую модель восстановления
8. Сжатие файлов журнала транзакций базы-приемника
9. Отмена назначение главного узла РИБ (указывается в параметре)
10. Отключение базы-приемника от хранилища
11. Подключение базы-приемника к хранилищу
12. Обновление конфигурации базы данных базы-приемника
13. Снятие блокировки регламентных заданий и начала сеансов базы-приемника
14. Уведомление о результате по электронной почте

Отработав, Перезаливатор выдаст соответствующее сообщение (или сообщение об ошибке), а также отправит сообщение о результате работы на электронную почту.

<img src="Screenshots/Perezalivator22.png" alt="Скриншот22">

# Удаление ИБ

Можно удалить информационную базу вместе с базой данных.

<img src="Screenshots/Perezalivator23.png" alt="Скриншот23">

1. Устанавливаем признак удаления Информационной базы Назначения (из Приемника)
    > Удалению подлежат только ИБ приемники
2. Выбираем преднастроенную ИБ
3. Можно указать конкретную ИБ по имени

